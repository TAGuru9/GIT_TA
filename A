WITH runs AS (
    SELECT
        r.RN_RUN_ID,
        r.RN_TEST_ID,
        t.TS_NAME AS Test_Name,
        r.RN_EXECUTION_DATE,
        r.RN_STATUS,
        r.RN_TESTER_NAME AS Resource
    FROM amfc_isqat_db.td.run r
    JOIN amfc_isqat_db.td.test t 
        ON r.RN_TEST_ID = t.TS_TEST_ID
)
SELECT
    YEAR(RN_EXECUTION_DATE)  AS [Year],
    MONTH(RN_EXECUTION_DATE) AS [Month],
    Resource,

    -- Automated = TA_ prefix
    SUM(CASE WHEN Test_Name LIKE 'TA_%' THEN 1 ELSE 0 END) AS Automated_Count,

    -- Non-Automated = anything not TA_ 
    SUM(CASE WHEN Test_Name NOT LIKE 'TA_%' THEN 1 ELSE 0 END) AS NonAutomated_Count,

    -- Total
    COUNT(*) AS Total_Executions,

    -- Automation %
    CASE 
        WHEN COUNT(*) = 0 THEN 0
        ELSE ROUND(
            100.0 * SUM(CASE WHEN Test_Name LIKE 'TA_%' THEN 1 END) / COUNT(*),
            2
        )
    END AS Automation_Percentage

FROM runs
GROUP BY
    YEAR(RN_EXECUTION_DATE),
    MONTH(RN_EXECUTION_DATE),
    Resource
ORDER BY
    [Year],
    [Month],
    Resource;

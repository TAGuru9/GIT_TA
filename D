DECLARE @Year INT = YEAR(GETDATE());   -- this year

SELECT
    ISNULL(T.TS_USER_01, 'Unknown') AS Application,

    SUM(CASE 
            WHEN T.TS_NAME LIKE 'TA\_%' ESCAPE '\' THEN 1 
            ELSE 0 
        END) AS Automated_Count,

    SUM(CASE 
            WHEN T.TS_NAME NOT LIKE 'TA\_%' ESCAPE '\' THEN 1 
            ELSE 0 
        END) AS Manual_Count,

    COUNT(*) AS Total_Count,

    CAST(
        100.0 * SUM(CASE 
                        WHEN T.TS_NAME LIKE 'TA\_%' ESCAPE '\' THEN 1 
                        ELSE 0 
                    END)
        / NULLIF(COUNT(*), 0)
        AS DECIMAL(5,2)
    ) AS Automation_Pct
FROM [amfc_isqat_db].[td].[RUN]  AS R
JOIN [amfc_isqat_db].[td].[TEST] AS T
    ON R.RN_TEST_ID = T.TS_TEST_ID
WHERE R.RN_STATUS IN ('Passed','Failed')
  AND YEAR(R.RN_EXECUTION_DATE) = @Year     -- this year only
GROUP BY ISNULL(T.TS_USER_01, 'Unknown')
ORDER BY Application;

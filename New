DECLARE @Year INT = 2025;  -- Example: 2025
DECLARE @Month INT = NULL; -- Example: 6 for June, or NULL for all months

/* --- Created and Modified Test Counts by Month --- */
SELECT
    YEAR(TS_CREATION_DATE) AS Run_Year,
    MONTH(TS_CREATION_DATE) AS Run_Month,

    -- Created
    SUM(CASE WHEN TS_NAME LIKE 'TA\_%' ESCAPE '\' THEN 1 ELSE 0 END) AS Created_Automated,
    SUM(CASE WHEN TS_NAME NOT LIKE 'TA\_%' ESCAPE '\' THEN 1 ELSE 0 END) AS Created_Manual,
    COUNT(*) AS Created_Total,

    -- Modified
    SUM(CASE WHEN TS_NAME LIKE 'TA\_%' ESCAPE '\' AND YEAR(TS_VTS) = @Year THEN 1 ELSE 0 END) AS Modified_Automated,
    SUM(CASE WHEN TS_NAME NOT LIKE 'TA\_%' ESCAPE '\' AND YEAR(TS_VTS) = @Year THEN 1 ELSE 0 END) AS Modified_Manual,
    SUM(CASE WHEN YEAR(TS_VTS) = @Year THEN 1 ELSE 0 END) AS Modified_Total,

    -- Automation %
    CONCAT(
        CAST(
            CAST(
                100.0 * SUM(CASE WHEN TS_NAME LIKE 'TA\_%' ESCAPE '\' THEN 1 ELSE 0 END)
                / NULLIF(COUNT(*), 0)
                AS DECIMAL(5,2)
            ) AS VARCHAR(10)
        ),
        '%'
    ) AS Automation_Pct
FROM [amfc_isqat_db].[td].[TEST]
WHERE YEAR(TS_CREATION_DATE) = @Year
  AND (@Month IS NULL OR MONTH(TS_CREATION_DATE) = @Month)
GROUP BY YEAR(TS_CREATION_DATE), MONTH(TS_CREATION_DATE)
ORDER BY Run_Year, Run_Month;
